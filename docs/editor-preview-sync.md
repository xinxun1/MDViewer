# 编辑器与预览双向同步功能

## 功能概述

v1.8.0 新增分栏模式下编辑器与预览的双向位置同步功能，让您可以在编辑和预览之间快速定位内容。

## 功能特性

### 🔄 双向同步

#### 1. 编辑器 → 预览
- **点击同步**：在编辑器中点击任意位置，预览自动滚动到对应内容
- **滚动同步**：编辑器滚动时，预览同步滚动

#### 2. 预览 → 编辑器
- **点击标题同步**：点击预览中的标题（H1-H6），编辑器自动跳转到对应的 Markdown 行
- **滚动同步**：预览滚动时，编辑器同步滚动

## 使用方法

### 前提条件
必须在**分栏模式**（Split Mode）下才能使用同步功能。

### 场景 1: 从编辑器定位到预览

1. 在编辑器中编辑文档
2. **点击某一行**或**移动光标**到想查看的位置
3. 预览区域自动滚动到对应的渲染内容

**示例**：
```markdown
# 第一章
这是第一章的内容...

## 1.1 小节
小节内容...       ← 点击这里

# 第二章
```
点击 "1.1 小节" 这行，预览会自动滚动显示该小节的渲染效果。

### 场景 2: 从预览定位到编辑器

1. 在预览区域浏览文档
2. **点击任意标题**（H1-H6）
3. 编辑器自动跳转到该标题的 Markdown 源码行
4. 光标自动定位到对应行

**示例**：
在预览中点击 "第二章" 标题，编辑器会自动滚动并定位到 `# 第二章` 这一行。

### 场景 3: 滚动同步

#### 编辑器滚动
1. 使用鼠标滚轮或滚动条在编辑器中滚动
2. 预览区域自动同步滚动到相应位置

#### 预览滚动
1. 使用鼠标滚轮或滚动条在预览区域滚动
2. 编辑器自动同步滚动到相应位置

## 视觉提示

### 标题悬停效果
- 鼠标悬停在预览的标题上时，标题背景会高亮
- 提示标题可以点击以跳转到编辑器

### 平滑滚动
- 所有滚动都使用平滑动画（`scroll-behavior: smooth`）
- 提供更好的视觉体验

## 工作原理

### 位置计算

#### 编辑器 → 预览
```javascript
// 计算光标在文档中的相对位置
const currentLine = 光标所在行数;
const totalLines = 总行数;
const ratio = currentLine / totalLines;

// 预览滚动到相同比例的位置
previewScroll = maxScroll * ratio;
```

#### 预览 → 编辑器（点击标题）
```javascript
// 1. 识别点击的标题元素
// 2. 提取标题文本
// 3. 在编辑器中搜索匹配的 Markdown 标题行
// 4. 滚动并定位光标到该行
```

#### 滚动同步
```javascript
// 计算滚动比例
const scrollRatio = scrollTop / maxScroll;

// 另一侧滚动到相同比例
otherSide.scrollTop = otherSide.maxScroll * scrollRatio;
```

### 防止循环同步

使用标志位避免无限循环：
- `isEditorScrolling` - 编辑器正在被同步滚动
- `isPreviewScrolling` - 预览正在被同步滚动
- 防抖延迟（50ms）避免频繁触发

## 使用技巧

### 1. 快速导航
在长文档中，点击预览的目录标题可以快速定位到编辑器的对应位置。

### 2. 对照编辑
编辑复杂内容（如表格、列表）时，编辑器操作会实时在预览中同步显示位置。

### 3. 内容校对
浏览预览时发现问题，点击标题即可跳转到编辑器修改。

### 4. Markdown 学习
观察编辑器输入与预览渲染的对应关系，学习 Markdown 语法。

## 注意事项

1. **仅分栏模式有效**
   - 纯预览模式（View Mode）没有编辑器，无法同步
   - 切换到分栏模式（Split Mode）后自动启用

2. **标题点击同步最准确**
   - 点击标题时能精确定位到对应行
   - 点击普通段落使用比例估算，可能不完全精确

3. **长文档性能**
   - 非常长的文档（>10000行）滚动同步可能有轻微延迟
   - 使用防抖机制优化性能

4. **不影响 Mermaid 图表**
   - 图表的双击缩放功能不受影响
   - 点击图表不会触发同步

## 控制台日志

开启浏览器控制台（F12）可以看到同步日志：

```
[Sync] 编辑器第 42/150 行 → 预览滚动到 28%
[Sync] 预览标题 "第二章" → 编辑器第 35 行
```

这些日志有助于调试和理解同步行为。

## 快捷键配合

配合其他快捷键使用：

| 操作 | 快捷键 | 说明 |
|------|--------|------|
| 保存文件 | Ctrl+S | 保存当前修改 |
| 切换分栏模式 | 点击工具栏 | 启用/禁用同步 |
| 搜索内容 | Ctrl+F | 在编辑器中搜索 |

## 相关功能

- [分栏模式指南](./split-mode-guide.md) - 了解分栏模式的使用
- [图表缩放功能](./zoom-feature-ready.md) - Mermaid 图表放大查看
- [图表拖动功能](./diagram-pan-feature.md) - 拖动查看大图

## 更新日志

- **v1.8.0** (2026-01-12)
  - ✨ 新增编辑器到预览的点击同步
  - ✨ 新增预览到编辑器的点击同步（标题）
  - ✨ 新增双向滚动同步
  - 🎨 标题悬停高亮提示
  - ⚡ 防抖优化，避免频繁触发
  - 🐛 防止循环同步的标志位

## 技术实现

### 事件监听
- `editor.onclick` - 编辑器点击事件
- `editor.onscroll` - 编辑器滚动事件
- `preview.onclick` - 预览点击事件（标题）
- `previewContainer.onscroll` - 预览滚动事件

### CSS 平滑滚动
```css
#editor,
.preview-container {
    scroll-behavior: smooth;
}
```

### 防抖机制
```javascript
setTimeout(() => {
    // 滚动同步代码
}, 50); // 50ms 防抖
```

## 反馈与建议

如果您有任何建议或发现问题，欢迎提供反馈！
